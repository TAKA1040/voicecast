# トラブルシューティング & デバッグガイド

## 1. 基本的な問題の切り分け

エラーが発生した場合、まず以下の点を切り分けます。

- **どこで起きているか？**: ローカル開発環境か、Vercelの本番環境か。
- **いつから起きているか？**: 特定のデプロイやコード変更がトリガーになっていないか。
- **誰に起きているか？**: 全てのユーザーか、特定のユーザーか。

## 2. `500 INTERNAL_SERVER_ERROR` / `MIDDLEWARE_INVOCATION_FAILED`

この種のエラーは、サーバーサイド（特にミドルウェアやAPIルート）で致命的な問題が発生していることを示します。

- **最優先の確認項目**: **VercelのFunctionログ**
    1. Vercelのダッシュボードにアクセスします。
    2. 対象のプロジェクトを選択し、`Functions` タブを開きます。
    3. エラーが発生した時刻に対応するログを探し、エラーメッセージとスタックトレースを確認します。ここに根本原因が記録されています。

- **よくある原因**:
    - 環境変数が設定されていない、または間違っている。
    - Edge RuntimeでサポートされていないNode.jsのAPIを使用している。
    - Supabaseクライアントの初期化に失敗している。

## 3. `404 NOT_FOUND`

- **ページが表示されない場合**:
    - **原因**: Vercelのルーティング設定に問題がある可能性があります。
    - **確認**: `vercel.json` の設定が正しいか、Next.jsの `app` ディレクトリの構造が意図通りか確認します。
- **APIリクエストが失敗する場合**:
    - **原因**: `fetch` 先のURLが間違っているか、対応するAPIルート (`app/api/...`) が存在しません。
    - **確認**: ブラウザの開発者ツール（ネットワークタブ）でリクエストURLを確認し、コードと見比べます。

## 4. ローカルでのビルド確認

Vercelでビルドが失敗する場合、ローカル環境でビルドを試すことで、より詳細なエラーメッセージが得られます。

```bash
npm run build
```

このコマンドを実行し、ローカルでビルドが成功するかどうかを確認することは、デバッグの重要なステップです。

## 5. Supabase CLIが `Unauthorized` となる場合

- **原因**: CLIが認証トークンを見つけられていない、または期限切れです。
- **解決策**:
    1. Supabaseのアクセストークンページ (`https://supabase.com/dashboard/account/tokens`) で新しいトークンを生成します。
    2. `run_supabase.bat` のようなラッパースクリプトを作成し、環境変数 `SUPABASE_ACCESS_TOKEN` にトークンをセットした上で、CLIコマンドを実行します。これにより、ローカルの環境差異の問題を確実に回避できます。
