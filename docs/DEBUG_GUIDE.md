# トラブルシューティング & デバッグガイド

## 1. 基本的な問題の切り分け

エラーが発生した場合、まず以下の点を切り分けます。

- **どこで起きているか？**: ローカル開発環境か、Firebaseの本番環境か。
- **いつから起きているか？**: 特定のデプロイやコード変更がトリガーになっていないか。
- **誰に起きているか？**: 全てのユーザーか、特定のユーザーか。

## 2. `500 INTERNAL_SERVER_ERROR`

このエラーは、Next.jsのサーバーサイド処理（SSR）で問題が発生していることを示します。

- **最優先の確認項目**: **Cloud Runのログ**
    1. Firebaseコンソールの `Hosting` ページにアクセスします。
    2. デプロイ履歴から、Next.jsバックエンドが動作しているCloud Runサービスのリンクをクリックします。
    3. Cloud Runの `ログ` タブを開き、エラーが発生した時刻に対応するログを探し、エラーメッセージとスタックトレースを確認します。ここに根本原因が記録されています。

- **よくある原因**:
    - サーバーサイドで利用している環境変数が設定されていない。
    - Firebase Admin SDKの初期化に失敗している。

## 3. 認証やFirestoreアクセスに関するエラー

- **エラーメッセージの確認**: ブラウザの開発者ツール（コンソール）に、Firebase SDKからの詳細なエラーメッセージ（`auth/user-not-found`, `permission-denied` など）が出力されます。
- **`permission-denied` の場合**:
    - **原因**: Firestoreのセキュリティルールによってアクセスが拒否されています。
    - **確認**:
        1. `firestore.rules` の内容を見直し、意図した操作を許可するルールが記述されているか確認します。
        2. FirebaseコンソールのFirestoreエミュレータや「ルール プレイグラウンド」を使い、ルールが正しく動作するかをテストします。

## 4. ローカルでのビルド確認

Firebase Hostingでビルドが失敗する場合、ローカル環境でビルドを試すことで、より詳細なエラーメッセージが得られます。

```bash
npm run build
```

このコマンドを実行し、ローカルでビルドが成功するかどうかを確認することは、デバッグの重要なステップです。

## 5. Firebase CLIが `Forbidden` となる場合

- **原因**: CLIが認証されていない、または現在のプロジェクトに対する権限がありません。
- **解決策**:
    1. `firebase login` を実行して、正しいGoogleアカウントでログインしているか確認します。
    2. `firebase projects:list` を実行し、操作対象のプロジェクトが表示されるか確認します。
    3. `firebase use <project_id>` を実行し、正しいプロジェクトに切り替わっているか確認します。