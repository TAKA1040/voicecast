# Supabase RLS (Row Level Security) ポリシー設定説明書

## 1. 概要

VoiceCastプロジェクトでは、SupabaseのRLS（Row Level Security）を有効にすることで、データベースのデータへのアクセスを認証されたユーザーに限定し、セキュリティを強化しています。これにより、不正なデータ操作を防ぎ、アプリケーションの堅牢性を保ちます。

## 2. `episodes` テーブルのRLSポリシー

`episodes` テーブルには、音声エピソードに関する情報が格納されています。このテーブルに対して、以下のRLSポリシーが設定されています。

### SELECTポリシー

- **目的**: 認証されたユーザーのみがエピソードを読み取れるようにします。
- **ポリシー文**:
  ```sql
  SELECT : auth.role() = 'authenticated'
  ```
- **説明**:
  このポリシーは、`episodes` テーブルからデータを取得（SELECT）する際に適用されます。`auth.role() = 'authenticated'` は、現在認証されているユーザーのロールが `'authenticated'` である場合にのみ、データの読み取りを許可するという条件です。これにより、ログインしていない匿名ユーザーはエピソード一覧を閲覧できません。

### INSERT/UPDATE/DELETEポリシー

- **目的**: 認証されたユーザーのみがエピソードの作成、更新、削除を行えるようにします。
- **ポリシー文**:
  ```sql
  INSERT/UPDATE/DELETE : auth.role() = 'authenticated'
  ```
- **説明**:
  このポリシーは、`episodes` テーブルにデータを挿入（INSERT）、更新（UPDATE）、または削除（DELETE）する際に適用されます。`auth.role() = 'authenticated'` の条件により、認証済みのユーザーのみがこれらの操作を実行できます。これにより、未認証のユーザーが勝手にエピソードを投稿したり、既存のエピソードを改ざん・削除したりすることを防ぎます。

## 3. RLSポリシーの構成

これらのポリシーは、Supabaseの管理画面から設定されています。

- **RLSの有効化**: `episodes` テーブルの「Row Level Security」が有効（ON）になっていることを確認してください。
- **ポリシーの追加**: 上記のポリシー文が、それぞれ「SELECT」と「INSERT/UPDATE/DELETE」のアクションに対して追加されていることを確認してください。

## 4. 認証ユーザーしか投稿できない構成

上記のRLSポリシーにより、VoiceCastプロジェクトでは「認証されたユーザーしかエピソードを投稿できない」という構成が実現されています。

1. **ログイン**: ユーザーは `admin/login.html` からメールアドレスとパスワードでログインします。
2. **認証**: ログインが成功すると、Supabaseによってユーザーが認証され、`authenticated` ロールが付与されます。
3. **エピソード投稿**: 認証されたユーザーは `admin/admin.html` からエピソードをアップロード・登録できます。この際、`INSERT` ポリシーが適用され、`authenticated` ロールを持つユーザーのみが操作を許可されます。

この仕組みにより、VoiceCastのコンテンツは、信頼できる認証済みの配信者によってのみ管理されることが保証されます。
